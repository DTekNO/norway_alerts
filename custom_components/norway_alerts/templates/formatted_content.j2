{%- if alerts and alerts | length > 0 -%}

{%- if compact_view -%}
{#- Compact view - all alert icons in a single row -#}
<table role="presentation">
<tr>
{%- for alert in alerts %}
<td width="70" align="center" valign="top">
{%- if show_icon and alert.get('entity_picture') %}<img src="{{ alert.entity_picture }}" width="64" height="64" title="{{ alert.get('event', 'Alert') }} - {{ alert.get('severity', 'unknown') | capitalize }}">{% endif -%}
</td>
{%- endfor %}
</tr>
</table>

{%- else -%}
{#- Full view - all details for each alert -#}
{%- for alert in alerts -%}
{%- set start_ts = alert.get('starttime_timestamp') -%}
{%- set end_ts = alert.get('endtime_timestamp') -%}
{%- set now_ts = now_timestamp -%}
{%- set severity = alert.get('severity', 'unknown') | lower -%}
{%- set alert_type = 'error' if severity in ['severe', 'extreme'] else ('warning' if severity in ['moderate', 'minor'] else 'info') -%}
{%- set status = 'Expected' if start_ts and end_ts and start_ts > now_ts else ('Ended' if start_ts and end_ts and end_ts < now_ts else 'Ongoing') -%}
{%- set title = (status ~ ' - ' if show_status and start_ts and end_ts else '') ~ alert.get('event', 'Alert') -%}

{%- if loop.index0 > 0 %}<br>
{% endif %}

{# Icon alert with severity-based color #}
<ha-alert alert-type="{{ alert_type }}">

<table role="presentation">
<tr>
<td><b>{{ title }}</b></td>
{%- if show_icon and alert.get('entity_picture') %}
<td rowspan="2" width="40"><img src="{{ alert.entity_picture }}" width="40" height="40"></td>
{%- endif %}
</tr>
<tr>
<td>{{ alert.get('severity', 'unknown') | capitalize }} severity</td>
</tr>
</table>

</ha-alert>

{# Main alert with all details #}
<ha-alert alert-type="{{ alert_type }}" title="Description">

{%- if alert.get('description') %} 

{{ alert.description }}
{% endif %}
{%- if alert.get('instruction') %}

**Instructions**

{{ alert.instruction }}
{% endif %}
{%- if alert.get('consequences') %}

**Consequences**

{{ alert.consequences }}
{% endif %}
{%- if alert.get('area') %}

**Area**: {{ alert.area }}
{% endif %}
{%- if alert.get('certainty') or alert.get('severity') or alert.get('level_name') %}

{%- if alert.get('certainty') %}**Certainty**: {{ alert.certainty }}{% endif -%}{%- if alert.get('certainty') and (alert.get('severity') or alert.get('level_name')) %} | {% endif -%}{%- if alert.get('severity') or alert.get('level_name') %}**Severity**: {{ alert.get('severity', alert.get('level_name', '')) }}{% endif %}
{% endif %}
{%- if show_map and alert.get('map_url') %}

<img src="{{ alert.map_url }}" width="400">
{% endif %}

{%- if start_ts and end_ts %}

**Time period**

<table role="presentation">
  <tr>
    <td align="right"><b>Start:&nbsp;</b></td><td><i>{{ alert.start_formatted }} - increasing danger</i></td>
  </tr>
  <tr>
    <td align="right"><b>End:&nbsp;</b></td><td><i>{{ alert.end_formatted }} - decreasing danger</i></td>
  </tr>
</table>
{% endif %}

</ha-alert>

{% endfor %}
{% endif %}
{%- else -%}
No active alerts
{%- endif -%}
